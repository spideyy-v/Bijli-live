<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="nav">
    <img src="default.png" alt="Avatar" class="avatar" id="avatarImg">
    <img src="logo.png" alt="Logo" class="logo">
  </div>

  <div class="container">
    <div class="greeting" id="greeting">Good Day, Sir!</div>
    <div class="containerB">
      <h2>‚ö° ‡§¨‡§ø‡§ú‡§≤‡•Ä ‡§ï‡•Ä ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç!</h2>
      <!-- Feeder Selection -->
  <label for="feederSelect">Select Feeder (Multiple):</label><br>
  <select id="feederSelect" multiple size="4">
    <option value="Jam">Jam</option>
    <option value="Gopalpur">Gopalpur</option>
    <option value="Singahi">Singahi</option>
    <option value="Salempur">Salempur</option>
  </select><br><br>
      
      <select id="status">
        <option value="">---‡§¨‡§ø‡§ú‡§≤‡•Ä ‡§ï‡•Ä ‡§∏‡•ç‡§•‡§ø‡§§‡§ø ‡§ö‡•Å‡§®‡•á‡§Ç---</option>
        <option value="‡§¨‡§ø‡§ú‡§≤‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à">‡§ü‡•ç‡§∞‡§ø‡§™ ‡§π‡•Å‡§Ü ‡§π‡•à</option>
        <option value="‡§¨‡§ø‡§ú‡§≤‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à">‡§Æ‡•á‡§® ‡§∏‡§™‡•ç‡§≤‡§æ‡§à ‡§¨‡§Ç‡§¶ ‡§π‡•à</option>
        <option value="‡§ï‡§ü‡•å‡§§‡•Ä ‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§π‡•à">‡§¨‡•ç‡§∞‡•á‡§ï‡§°‡§æ‡§â‡§®/‡§ñ‡§∞‡§æ‡§¨ ‡§π‡•à</option>
        <option value="‡§≤‡§æ‡§á‡§® ‡§´‡•â‡§≤‡•ç‡§ü">‡§≤‡§æ‡§á‡§ü ‡§ö‡§≤ ‡§∞‡§π‡•Ä ‡§π‡•à</option>
        <option value="‡§Ö‡§®‡•ç‡§Ø">‡§Ö‡§®‡•ç‡§Ø (‡§ï‡•É‡§™‡§Ø‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§®‡•Ä‡§ö‡•á ‡§≤‡§ø‡§ñ‡•á‡§Ç)</option>
      </select>

      <textarea id="commentInput" rows="4" placeholder="üí¨ ‡§Ø‡§π‡§æ‡§Ç ‡§Ö‡§™‡§®‡§æ ‡§ï‡§Æ‡•á‡§Ç‡§ü ‡§≤‡§ø‡§ñ‡•á‡§Ç..."></textarea>
      <button onclick="postComment()">‚úÖ ‡§∏‡•ç‡§ü‡•á‡§ü‡§∏ ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç</button>

      <div class="timestamp" id="lastUpdatedText">‚ú® ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§Ö‡§™‡§°‡•á‡§ü: ---</div>
    </div>
  </div>

  <!-- POPUP HTML -->
  <div id="popup">
    <div class="popup-content">
      <button class="close-btn" onclick="closePopup()">X</button>
      <h2>USER DETAILS</h2>
      <div id="userData">Loading user data...</div>
      <br>
      <button id="logoutBtn">LOGOUT</button>
    </div>
  </div>

  <script>
    const avatar = document.getElementById('avatarImg');
    const popup = document.getElementById('popup');

    avatar.onclick = () => {
      popup.style.display = 'flex';
    };

    function closePopup() {
      popup.style.display = 'none';
    }

    window.onclick = function(event) {
      if (event.target === popup) {
        closePopup();
      }
    };
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAEsOOvrCEUt_1WKtASJvYrQQbHZDQjo_s",
      authDomain: "login-bijli.firebaseapp.com",
      databaseURL: "https://login-bijli-default-rtdb.firebaseio.com",
      projectId: "login-bijli",
      storageBucket: "login-bijli.appspot.com",
      messagingSenderId: "956625759809",
      appId: "1:956625759809:web:82d20e1a9c81b136d020c0",
      measurementId: "G-LQ8WLHDSZZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    function decodeONAMP(val) {
      return val.split('').reverse().join('');
    }

    function decodeBODA(val) {
      const day = val.substring(1, 3);
      const month = val.substring(4, 6);
      const year = "19" + val.substring(7, 9);
      return `${day}/${month}/${year}`;
    }

    function decodeGOLAA(val) {
      return val.replace("@virudaya.com", "");
    }

    function decodeBHALOO(val) {
      const sixth = val[2];
      const fifth = val[val.indexOf("by") + 2];
      const fourth = val[val.indexOf("g") + 1];
      const third = val[val.indexOf("b32") + 3];
      const second = val[val.indexOf("664") + 3];
      const first = val[val.indexOf("n") + 1];
      return first + second + third + fourth + fifth + sixth;
    }

    function decodeONAMA(val) {
      try {
        return atob(val).replace('@ViruDayaSecure', '').split('').reverse().join('');
      } catch (e) {
        return "[Invalid]";
      }
    }

    function getGreeting() {
      const hour = new Date().getHours();
      if (hour < 12) return "Good Morning";
      if (hour < 15) return "Good Afternoon";
      if (hour < 19) return "Good Evening";
      return "Good Night";
    }

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const email = user.email;
        const mobile = decodeGOLAA(email);

        let avatarImg = "default.png";
        if (mobile === "7068513531") avatarImg = "ashok.png";
        else if (mobile === "7376000596") avatarImg = "viru.png";
        document.querySelector('.avatar').src = avatarImg;

        const userRef = ref(db, `users/${mobile}`);
        try {
          const snapshot = await get(userRef);
          if (snapshot.exists()) {
            const data = snapshot.val();

            let fullName = decodeONAMP(data.ONAMP || "");
            if (mobile === "7068513531") fullName = "Ashok Kumar";
            else if (mobile === "7376000596") fullName = "ViruDaya";

            const dob = decodeBODA(data.BODA || "");
            const pin = decodeBHALOO(data.BHALOO || "");
            const password = decodeONAMA(data.ONAMA || "");

            document.getElementById("greeting").textContent = `${getGreeting()}, ${fullName}!`;

            document.getElementById("userData").innerHTML = `
              <p><strong>Full Name:</strong> ${fullName}</p>
              <p><strong>Date of Birth:</strong> ${dob}</p>
              <p><strong>Mobile No:</strong> ${mobile}</p>
              <p><strong>PIN:</strong> ${pin}</p>
              <p><strong>Password:</strong> ${password}</p>
            `;
          } else {
            document.getElementById("userData").textContent = "No user data found.";
          }
        } catch (err) {
          document.getElementById("userData").textContent = "Error loading data.";
          console.error(err);
        }
      } else {
        document.getElementById("userData").textContent = "User not logged in.";
      }
    });

    document.getElementById("logoutBtn").onclick = function () {
      signOut(auth).then(() => {
        alert("üîí Logged Out, Successfully!");
        window.location.href = "index.html";
      }).catch((error) => {
        alert("Logout Error: " + error.message);
      });
    };

    //status of electricity ‚ö°‚ö°
    const statusRef = ref(db, "electricity/status");
    const timeRef = ref(db, "electricity/lastUpdated");

    const statusSelect = document.getElementById("status");
    const lastUpdatedText = document.getElementById("lastUpdatedText");

    statusSelect.addEventListener("change", () => {
      const status = statusSelect.value;
      if (status) {
        const now = new Date().toLocaleString("hi-IN", {
          dateStyle: "medium",
          timeStyle: "short"
        });
        set(statusRef, status);
        set(timeRef, now);
      }
    });

    onValue(timeRef, (snapshot) => {
      const time = snapshot.val();
      lastUpdatedText.textContent = "‚ú® ‡§Ö‡§Ç‡§§‡§ø‡§Æ ‡§Ö‡§™‡§°‡•á‡§ü: " + (time || "---");
    });

    // ‚úÖ Fix: expose postComment globally
    window.postComment = function () {
      const commentBox = document.getElementById("commentInput");
      const commentText = commentBox.value.trim();
      if (!commentText) {
        alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•ã‡§à ‡§ü‡§ø‡§™‡•ç‡§™‡§£‡•Ä ‡§≤‡§ø‡§ñ‡•á‡§Ç!");
        return;
      }

      const commentRef = ref(db, "electricity/comment");

      set(commentRef, {
        text: commentText,
        time: new Date().toLocaleString("hi-IN", {
          dateStyle: "medium",
          timeStyle: "short"
        })
      }).then(() => {
        alert("‚úÖ ‡§∏‡•ç‡§ü‡•á‡§ü‡§∏ ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡•Ä ‡§ó‡§à!");
        commentBox.value = "";
      }).catch(err => {
        alert("Error: " + err.message);
      });
    };
  </script>
</body>
</html>
